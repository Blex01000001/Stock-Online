<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="utf-8" />
    <title>台股 K 線圖</title>

    <!-- ECharts -->
    <script src="https://cdn.jsdelivr.net/npm/echarts/dist/echarts.min.js"></script>

    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: "Segoe UI", "Microsoft JhengHei", sans-serif;
            background: #f0f2f5;
        }

        /* 整條工具列（參考 stock-line.html） */
        #InputArea {
            position: sticky;
            top: 0;
            z-index: 100;
            background: #ffffff;
            border-bottom: 1px solid #ddd;
            padding: 10px;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        #QueryArea {
            display: flex;
            gap: 6px;
            align-items: center;
            background: #e3f2fd;
            padding: 6px;
            border-radius: 8px;
        }

        input,
        button {
            padding: 4px 6px;
        }

        .page {
            max-width: 1200px;
            margin: auto;
            padding: 16px;
        }

        .chart-card {
            background: #ffffff;
            border-radius: 8px;
            margin-bottom: 16px;
            padding: 8px 8px 16px 8px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
        }

        .chart-box {
            width: 100%;
            height: 560px;
        }

        .hint {
            font-size: 12px;
            color: #666;
            margin: 8px 0 0 2px;
        }
    </style>
</head>

<body>
    <div id="InputArea">
        <div id="QueryArea">
            <input type="text" id="inputStockIDField" placeholder="股票代號" style="width:90px;">
            <button class="search-btn" onclick="search()">搜尋</button>
        </div>
    </div>

    <div class="page">
        <div class="hint">
            ※ 每按一次搜尋就會在最上方新增一張 K 線圖卡片
        </div>
        <div id="chartList"></div>
    </div>

    <script>
        // 你原本是 7278，這裡沿用；需要的話自行改成 https / ngrok
        const apiBase = "http://localhost:7278";

        /**
         * 你後端回傳的資料格式我不知道你現在長什麼樣，
         * 所以這裡支援兩種常見格式：
         *
         * A) data.result = [{ date, open, high, low, close, volume }, ...]
         * B) data.result = [{ tradeDate, openPrice, highPrice, lowPrice, closePrice, volume }, ...]
         *
         * 你只要讓欄位對得上，就能畫出來。
         */
        async function search() {
            const stockId = document.getElementById("inputStockIDField").value?.trim();

            if (!stockId) {
                alert("請輸入股票代號");
                return;
            }

            // ⚠️ 這個 endpoint 你可以改成你自己的
            // 例如：/chart/kline?stockId=2330
            const url = `${apiBase}/chart/kline?stockId=${encodeURIComponent(stockId)}`;

            let res;
            try {
                res = await fetch(url);
            } catch (err) {
                alert("API 連線失敗：請確認 apiBase、CORS、後端是否啟動");
                console.error(err);
                return;
            }

            if (!res.ok) {
                const t = await res.text().catch(() => "");
                alert(`API 回應錯誤：HTTP ${res.status}\n${t}`);
                return;
            }

            const data = await res.json();
            const rows = data?.points ?? [];
            const maLines = data?.maLines ?? [];

            if (rows.length === 0) {
                alert("沒有資料");
                return;
            }

            renderKline(stockId, rows, maLines);
        }


        function renderKline(stockId, rows, maLines) {

            // === K 線 DTO 格式檢查（date + value[4]） ===
            const clean = rows.filter(p =>
                typeof p.date === "string" &&
                Array.isArray(p.value) &&
                p.value.length === 4 &&
                p.value.every(v => Number.isFinite(v))
            );

            if (clean.length === 0) {
                alert("資料格式不符合（K 線 value 異常）");
                return;
            }

            // === 1) 建立卡片 DOM（跟你的折線圖一致：prepend 新圖到最上方） ===
            const chartList = document.getElementById("chartList");

            const card = document.createElement("div");
            card.className = "chart-card";

            const chartDiv = document.createElement("div");
            chartDiv.className = "chart-box";

            card.appendChild(chartDiv);
            chartList.prepend(card);

            // === 2) 準備 ECharts 資料 ===
            const xData = clean.map(p => p.date);

            // ECharts candlestick data: [open, close, low, high]
            const kData = clean.map(p => p.value);
            const volData = clean.map(p => p.volume ?? 0);

            // 簡單的漲跌顏色分類（成交量柱狀）
            const volColor = clean.map(p => {
                const [open, close] = p.value;
                return close >= open ? 1 : -1;
            });

            const maSeries = maLines.map(ma => ({
                name: ma.name,
                type: "line",
                data: ma.values,
                smooth: true,
                showSymbol: false,
                lineStyle: {
                    width: 1
                }
            }));


            // === 3) 初始化圖表 ===
            const chart = echarts.init(chartDiv);

            const option = {
                title: {
                    text: `${stockId} K 線圖`,
                    left: "center",
                    top: 10
                },
                tooltip: {
                    trigger: "axis",
                    axisPointer: { type: "cross" },
                    valueFormatter: (value) => {
                        // tooltip 會把 array 也丟進來，這裡讓它別爆炸
                        if (Array.isArray(value)) return value.join(", ");
                        if (typeof value === "number") return value.toString();
                        return value;
                    }
                },
                legend: {
                    top: 40,
                    left: "center"
                },
                grid: [
                    { top: 90, left: 70, right: 30, height: 330 },  // K 線
                    { left: 70, right: 30, top: 450, height: 80 }   // 成交量
                ],
                xAxis: [
                    {
                        type: "category",
                        data: xData,
                        boundaryGap: false,
                        axisLabel: { fontSize: 11, rotate: 45, margin: 12 },
                        axisLine: { onZero: false },
                        splitLine: { show: false },
                        min: "dataMin",
                        max: "dataMax"
                    },
                    {
                        type: "category",
                        data: xData,
                        gridIndex: 1,
                        boundaryGap: false,
                        axisLabel: { show: false },
                        axisTick: { show: false },
                        axisLine: { show: false },
                        splitLine: { show: false },
                        min: "dataMin",
                        max: "dataMax"
                    }
                ],
                yAxis: [
                    {
                        scale: true,
                        axisLabel: { fontSize: 11 },
                        splitLine: {
                            lineStyle: { type: "dashed", opacity: 0.6 }
                        }
                    },
                    {
                        scale: true,
                        gridIndex: 1,
                        axisLabel: { fontSize: 11 },
                        splitLine: { show: false }
                    }
                ],
                dataZoom: [
                    { type: "inside", xAxisIndex: [0, 1], start: 60, end: 100 },
                    { type: "slider", xAxisIndex: [0, 1], top: 540, height: 20, start: 60, end: 100 }
                ],
                series: [
                    {
                        name: "K線",
                        type: "candlestick",
                        data: kData,
                        // 你如果想要更細緻的顏色控制可以再加 itemStyle
                    },
                    ...maSeries,
                    {
                        name: "成交量",
                        type: "bar",
                        xAxisIndex: 1,
                        yAxisIndex: 1,
                        data: volData,
                        // 用正負值簡單分漲跌柱
                        itemStyle: {
                            color: (params) => (volColor[params.dataIndex] >= 0 ? "#26a69a" : "#ef5350")
                        },
                        barMaxWidth: 12
                    }
                ]
            };

            chart.setOption(option);

            // 讓容器變更大小時自動 resize（避免卡片寬度變化後圖不跟著）
            const ro = new ResizeObserver(() => chart.resize());
            ro.observe(chartDiv);
        }
    </script>

</body>

</html>