<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="utf-8" />
    <title>Taiwan Stock Online</title>
    <script src="https://cdn.jsdelivr.net/npm/@microsoft/signalr@8.0.7/dist/browser/signalr.min.js"></script>

    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 2px;
        }

        .form-container {
            width: 1000px;
            /* 所有 form-row 的共同寬度 */
            margin: 0 auto;
            /* 整個表單區塊置中 */
            justify-content: center;
            /* 水平 */
        }

        .form-row1 {
            margin-bottom: 12px;
            width: 450px;
            display: flex;
            align-items: center;
        }

        .form-row2 {
            margin-bottom: 12px;

            display: flex;
            align-items: center;
        }

        h2 {
            text-align: center;
            font-size: 25px;
            /* 字體大小 */
            margin: 6px 0;
            /* 上下 16px，左右 0 */
        }

        label {
            display: inline-block;
            width: 140px;
        }

        input,
        select,
        button {
            padding: 6px;
            width: 220px;
        }

        button {
            width: 350px;
            padding: 10px 16px;
            /* ← 重點 */
            margin-right: 6px;
            cursor: pointer;
        }

        #result {
            margin-top: 20px;
            padding: 10px;
            border: 1px solid #ccc;
            max-height: 300px;
            overflow-y: auto;
            background: #fafafa;
            font-size: 14px;
        }

        .log {
            margin-bottom: 4px;
        }
    </style>
</head>

<body>

    <h2>股票資料更新</h2>
    <div class="form-container">
        <div class="form-row1">
            <label>常用股票：</label>
            <select id="stockPreset">
                <option value="">-- 選擇 --</option>
                <option value="0050">0050 元大台灣50</option>
                <option value="0056">0056 高股息</option>
                <option value="00878">00878 國泰永續高股息</option>

                <option value="9924">9924 福興</option>
                <option value="8112">8112 至上</option>
                <option value="2352">2352 佳世達</option>
                <option value="1102">1102 亞泥</option>
                <option value="2412">2412 中華電</option>
                <option value="2886">2886 兆豐金</option>
                <option value="9933">9933 中鼎</option>
                <option value="2884">2884 玉山金</option>
                <option value="2881">2881 富邦金</option>
                <option value="2882">2882 國泰金</option>
                <option value="6188">6188 廣明</option>
                <option value="2330">2330 台積電</option>
            </select>
        </div>

        <div class="form-row1">
            <label>股票代號：</label>
            <input type="text" id="stockId" placeholder="例如 2330" />
        </div>

        <div class="form-row1">
            <label>起始年份：</label>
            <input type="number" id="startYear" value="2010" />
        </div>

        <div class="form-row2">
            <button onclick="updateSingleStock()">更新單一股票（單一年）</button>
            <button onclick="updatePresetStocks()">更新常用股票（單一年）</button>
            <button onclick="updateAllStocks()">更新全部台股股票（單一年）</button>
        </div>
    </div>
    <div id="result"></div>

    <script>
        new signalR.HubConnectionBuilder()
            .withUrl("http://localhost:7278/stockUpdateHub")

        const conn = new signalR.HubConnectionBuilder()
            .withUrl("http://localhost:7278/stockUpdateHub", {
                withCredentials: true
            })
            .configureLogging(signalR.LogLevel.Information)
            .build();

        conn.on("Progress", msg => {
            console.log("收到 Progress:", msg);
            appendLog(msg);
        });

        conn.start()
            .then(() => console.log("✅ SignalR 已連線"))
            .catch(err => console.error("❌ SignalR 連線失敗", err));


        const apiBase = "http://localhost:7278";

        const presetStocks = [
            "0050", "0056", "00878", "9924", "8112", "2352", "1102", "2412", "2886", "9933", "2884", "2881", "2882", "6188", "2330"
            //all//"2327", "5880", "3034", "2883", "3008", "2002", "1303", "2603", "6919", "2059","5871", "2207", "5876", "1301", "3045", "4904", "2395", "4938", "2912", "2615","2609", "6505", "6446", "2618", "2376", "2449", "1504", "3036", "2356", "3044","4958", "2324", "2105", "1102", "2347", "6239", "2385", "3005", "3702", "2377","2353", "2474", "2027", "1477", "6176", "9904", "6285", "3023", "1319", "2006","9941", "5347", "1402", "5434", "6257", "4766", "6196", "3030", "4915", "9939","2610", "2206", "1210", "9917", "2393", "6278", "6670", "2504", "2441", "1215","2607", "2850", "3010", "2015", "6605", "3592", "2404", "8299", "6121", "5522","2606", "3211", "2637", "2451", "4763", "2371", "2458", "8112", "6005", "6757","5508", "6412", "8070", "2439", "2520", "1442", "1326", "2409", "2633", "9945","2352", "2845", "2915", "1722", "8454", "5483", "3260", "3264", "6147", "3227","5388", "8016", "4961", "6197", "3617", "3078", "3090", "6206", "2801", "3037","3665", "1101", "2834", "1590", "9910", "1476", "3706", "6472", "6789", "2838","6409", "8210", "2889", "6592", "2211", "2201", "2204", "2855", "8926", "6414","1609", "9933", "2467", "3042", "6214", "2362", "2515", "1707", "9930", "2103","8131", "6806", "5515"
        ];

        document.getElementById("stockPreset").addEventListener("change", function () {
            document.getElementById("stockId").value = this.value;
        });

        function appendLog(message) {
            const container = document.getElementById("result");

            const div = document.createElement("div");
            div.className = "log";
            div.innerText = `[${new Date()}] ${message}`;

            container.appendChild(div);

            // ✅ 自動捲到最新訊息
            container.scrollTop = container.scrollHeight;
        }

        async function updateSingleStock() {
            const stockId = document.getElementById("stockId").value;
            const startYear = document.getElementById("startYear").value;

            if (!stockId) {
                alert("請輸入股票代號");
                return;
            }

            appendLog(`開始更新股票 ${stockId}（${startYear} 年）`);

            const res = await fetch(`${apiBase}/stock/update/single-stock`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    stockId: stockId,
                    startYear: parseInt(startYear)
                })
            });

            const text = await res.text();
            appendLog(text);
        }

        async function updatePresetStocks() {
            const year = document.getElementById("startYear").value;
            const total = presetStocks.length;

            appendLog(`開始更新常用股票（${year} 年），共 ${total} 檔`);

            for (let i = 0; i < total; i++) {
                const stockId = presetStocks[i];
                const current = i + 1;

                appendLog(`[${current}/${total}] → 更新 ${stockId} 中...`);

                try {
                    const res = await fetch(`${apiBase}/stock/update`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            stockId: stockId,
                            startYear: parseInt(year)
                        })
                    });

                    const text = await res.text();
                    appendLog(`[${current}/${total}] ✔ ${stockId} 完成：${text}`);
                } catch (err) {
                    appendLog(`[${current}/${total}] ✖ ${stockId} 失敗`);
                }

                // 禮貌 delay，避免打爆 API
                await new Promise(r => setTimeout(r, 300));
            }

            appendLog(`常用股票更新完成（${total}/${total}）`);
        }
        function sortStockPreset() {
            const select = document.getElementById("stockPreset");

            // 保留第一個 "-- 選擇 --"
            const defaultOption = select.options[0];

            const options = Array.from(select.options)
                .slice(1)
                .sort((a, b) => a.value.localeCompare(b.value));

            // 清空後重新加入
            select.innerHTML = "";
            select.appendChild(defaultOption);

            options.forEach(opt => select.appendChild(opt));
        }
        async function updateAllStocks() {
            const year = document.getElementById("startYear").value;

            if (!year) {
                alert("請輸入年份");
                return;
            }

            try {
                const res = await fetch(
                    `${apiBase}/stock/update/all-stock?year=${year}`,
                    { method: "POST" }
                );

                const text = await res.text();
                appendLog(text);
            }
            catch {
                appendLog("✖ 更新台股股票失敗");
            }
        }

        // 頁面載入後排序
        sortStockPreset();

    </script>

</body>

</html>