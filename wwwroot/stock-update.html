<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="utf-8" />
    <title>Taiwan Stock Online</title>
    <script src="https://cdn.jsdelivr.net/npm/@microsoft/signalr@8.0.7/dist/browser/signalr.min.js"></script>

    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 2px;
        }

        .form-container {
            width: 1000px;
            margin: 0 auto;
            justify-content: center;
        }

        .form-row1 {
            margin-bottom: 12px;
            width: 450px;
            display: flex;
            align-items: center;
        }

        .form-row2 {
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            flex-wrap: wrap;
            gap: 8px;
            font-size: 20px;
        }

        .form-row2 button {
            font-size: 24px;
            font-weight: 500;
        }


        h2 {
            text-align: center;
            font-size: 25px;
            margin: 6px 0;
        }

        label {
            display: inline-block;
            width: 140px;
        }

        input,
        select {
            padding: 6px;
            width: 250px;
        }

        button {
            width: 400px;
            padding: 10px 16px;
            margin-right: 6px;
            cursor: pointer;
        }

        #result {
            margin-top: 20px;
            padding: 10px;
            border: 1px solid #ccc;
            max-height: 300px;
            overflow-y: auto;
            background: #fafafa;
            font-size: 14px;
        }

        .log {
            margin-bottom: 4px;
        }
    </style>
</head>

<body>

    <h2>è‚¡ç¥¨è³‡æ–™æ›´æ–°</h2>
    <div class="form-container">

        <!-- âœ… æ–°å¢ï¼šä¾ UpdateCommand çš„ä¸‹æ‹‰é¸å–® -->
        <div class="form-row1">
            <label>StockScopeï¼š</label>
            <select id="scopeSelect">
                <option value="Single" selected>Singleï¼ˆå–®ä¸€ï¼‰</option>
                <option value="Common">Commonï¼ˆå¸¸ç”¨ï¼‰</option>
                <option value="All">Allï¼ˆå…¨éƒ¨ï¼‰</option>
            </select>
        </div>

        <div class="form-row1">
            <label>DataTypeï¼š</label>
            <!-- å…ˆç”¨å–®é¸ï¼ˆæœ€ç©©ï¼‰ï¼›å¾Œç«¯ TargetDataTypes ä»æœƒé€ List -->
            <select id="dataTypeSelect">
                <option value="PriceUpdater" selected>Price</option>
                <option value="DividendUpdater">Dividend</option>
                <option value="InstitutionalUpdater">Institutional</option>
            </select>
        </div>

        <div class="form-row1">
            <label>TimeScopeï¼š</label>
            <select id="timeSelect">
                <option value="SpecificYear" selected>SpecificYearï¼ˆæŒ‡å®šå¹´ï¼‰</option>
                <option value="FullHistory">FullHistoryï¼ˆå…¨æ­·å²ï¼‰</option>
            </select>
        </div>

        <!-- ä½ åŸæœ¬çš„å¸¸ç”¨è‚¡ç¥¨ä¸‹æ‹‰ä¿ç•™ -->
        <div class="form-row1">
            <label>å¸¸ç”¨è‚¡ç¥¨ï¼š</label>
            <select id="stockPreset">
                <option value="">-- é¸æ“‡ --</option>
                <option value="0050">0050 å…ƒå¤§å°ç£50</option>
                <option value="0056">0056 é«˜è‚¡æ¯</option>
                <option value="00878">00878 åœ‹æ³°æ°¸çºŒé«˜è‚¡æ¯</option>

                <option value="9924">9924 ç¦èˆˆ</option>
                <option value="8112">8112 è‡³ä¸Š</option>
                <option value="2352">2352 ä½³ä¸–é”</option>
                <option value="1102">1102 äºæ³¥</option>
                <option value="2412">2412 ä¸­è¯é›»</option>
                <option value="2886">2886 å…†è±é‡‘</option>
                <option value="9933">9933 ä¸­é¼</option>
                <option value="2884">2884 ç‰å±±é‡‘</option>
                <option value="2881">2881 å¯Œé‚¦é‡‘</option>
                <option value="2882">2882 åœ‹æ³°é‡‘</option>
                <option value="6188">6188 å»£æ˜</option>
                <option value="2330">2330 å°ç©é›»</option>
            </select>
        </div>

        <div class="form-row1">
            <label>è‚¡ç¥¨ä»£è™Ÿï¼š</label>
            <input type="text" id="stockId" placeholder="ä¾‹å¦‚ 2330" />
        </div>

        <div class="form-row1">
            <label>å¹´ä»½ï¼š</label>
            <input type="number" id="startYear" value="2026" />
        </div>



        <!-- âœ… å–®ä¸€æŒ‰éˆ• -->
        <div class="form-row2">
            <button onclick="executeUpdate()">Update Now</button>
        </div>
    </div>

    <div id="result"></div>

    <script>
        const apiBase = "http://localhost:7278";

        // SignalR
        const conn = new signalR.HubConnectionBuilder()
            .withUrl("http://localhost:7278/stockUpdateHub", { withCredentials: true })
            .configureLogging(signalR.LogLevel.Information)
            .build();

        conn.on("Progress", msg => {
            console.log("æ”¶åˆ° Progress:", msg);
            appendLog(msg);
        });

        conn.start()
            .then(() => console.log("âœ… SignalR å·²é€£ç·š"))
            .catch(err => console.error("âŒ SignalR é€£ç·šå¤±æ•—", err));

        function appendLog(message) {
            const container = document.getElementById("result");
            const div = document.createElement("div");
            div.className = "log";
            div.innerText = `[${new Date()}] ${message}`;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        // ä¾ Scope/Time å‹•æ…‹å•Ÿç”¨è¼¸å…¥æ¬„ä½
        function refreshUiState() {
            const scope = document.getElementById("scopeSelect").value;
            const time = document.getElementById("timeSelect").value;

            const stockPreset = document.getElementById("stockPreset");
            const stockId = document.getElementById("stockId");
            const startYear = document.getElementById("startYear");

            // Scope
            if (scope === "Single") {
                stockPreset.disabled = false;
                stockId.disabled = false;
            } else {
                // Common / Allï¼šä¸éœ€è¦ specificStockId
                stockPreset.disabled = true;
                stockId.disabled = true;
            }

            // Time
            if (time === "SpecificYear") {
                startYear.disabled = false;
            } else {
                // FullHistoryï¼šä¸éœ€è¦ specificYear
                startYear.disabled = true;
            }
        }

        document.getElementById("scopeSelect").addEventListener("change", refreshUiState);
        document.getElementById("timeSelect").addEventListener("change", refreshUiState);

        // å¸¸ç”¨è‚¡ç¥¨é¸äº†å°±å¸¶å…¥ stockIdï¼ˆåªæœ‰ Single ç”¨å¾—åˆ°ï¼‰
        document.getElementById("stockPreset").addEventListener("change", function () {
            document.getElementById("stockId").value = this.value;
        });

        function sortStockPreset() {
            const select = document.getElementById("stockPreset");
            const defaultOption = select.options[0];

            const options = Array.from(select.options)
                .slice(1)
                .sort((a, b) => a.value.localeCompare(b.value));

            select.innerHTML = "";
            select.appendChild(defaultOption);
            options.forEach(opt => select.appendChild(opt));
        }

        // âœ… æ ¸å¿ƒï¼šä¾ UpdateCommand çµ„ request
        function buildCommand() {
            const scope = document.getElementById("scopeSelect").value;     // "Single" / "Common" / "All"
            const dataType = document.getElementById("dataTypeSelect").value; // "PriceUpdater"...
            const time = document.getElementById("timeSelect").value;       // "SpecificYear" / "FullHistory"

            const stockId = document.getElementById("stockId").value?.trim();
            const yearRaw = document.getElementById("startYear").value;

            const cmd = {
                scope: scope,
                specificStockId: null,
                targetDataTypes: [dataType],
                time: time,
                specificYear: null
            };

            if (scope === "Single") {
                if (!stockId) throw new Error("è«‹è¼¸å…¥è‚¡ç¥¨ä»£è™Ÿï¼ˆScope=Single æ‰éœ€è¦ï¼‰");
                cmd.specificStockId = stockId;
            }

            if (time === "SpecificYear") {
                const year = parseInt(yearRaw, 10);
                if (!year || year < 1900) throw new Error("è«‹è¼¸å…¥æ­£ç¢ºå¹´ä»½ï¼ˆTime=SpecificYear æ‰éœ€è¦ï¼‰");
                cmd.specificYear = year;
            }

            return cmd;
        }

        async function executeUpdate() {
            let command;
            try {
                command = buildCommand();
            } catch (e) {
                alert(e.message);
                return;
            }

            appendLog(formatCommand(command));

            try {
                const res = await fetch(`${apiBase}/stock/execute`, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(command)
                });

                const text = await res.text();
                appendLog(formatResponse(res.status, text));
            } catch (err) {
                console.error(err);
                appendLog("âœ– æ›´æ–°è«‹æ±‚é€å‡ºå¤±æ•—ï¼ˆè«‹æª¢æŸ¥ API æ˜¯å¦å•Ÿå‹• / CORSï¼‰");
            }
        }
        function formatCommand(command) {
            const scopeText = {
                "Single": "å–®ä¸€è‚¡ç¥¨",
                "Common": "å¸¸ç”¨è‚¡ç¥¨",
                "All": "å…¨éƒ¨è‚¡ç¥¨"
            }[command.scope] ?? command.scope;

            const timeText = {
                "SpecificYear": "æŒ‡å®šå¹´ä»½",
                "FullHistory": "å…¨éƒ¨æ­·å²"
            }[command.time] ?? command.time;

            const dataText = (command.targetDataTypes || [])
                .map(x => x.replace("Updater", ""))
                .join(", ");

            let msg = `ğŸ“¤ é–‹å§‹æ›´æ–° â†’ ç¯„åœ: ${scopeText} | é¡å‹: ${dataText} | æ™‚é–“: ${timeText}`;

            if (command.scope === "Single")
                msg += ` | è‚¡ç¥¨: ${command.specificStockId}`;

            if (command.time === "SpecificYear")
                msg += ` | å¹´ä»½: ${command.specificYear}`;

            return msg;
        }
        function formatResponse(status, text) {
            try {
                const json = JSON.parse(text);

                if (json.jobId)
                    return `âœ… ä»»å‹™å·²å»ºç«‹ ${json.jobId}`;

                return `âš ï¸ API å›æ‡‰ (${status}): ${text}`;
            }
            catch {
                return `âš ï¸ API å›æ‡‰ (${status}): ${text}`;
            }
        }


        // é é¢è¼‰å…¥ï¼šæ’åº + å¥—é è¨­ç‹€æ…‹
        sortStockPreset();
        refreshUiState();

    </script>

</body>

</html>