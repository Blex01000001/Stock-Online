<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="utf-8" />
    <title>Taiwan Stock Online</title>
    <script src="https://cdn.jsdelivr.net/npm/@microsoft/signalr@8.0.7/dist/browser/signalr.min.js"></script>

    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 2px;
        }

        .form-container {
            width: 1000px;
            /* æ‰€æœ‰ form-row çš„å…±åŒå¯¬åº¦ */
            margin: 0 auto;
            /* æ•´å€‹è¡¨å–®å€å¡Šç½®ä¸­ */
            justify-content: center;
            /* æ°´å¹³ */
        }

        .form-row1 {
            margin-bottom: 12px;
            width: 450px;
            display: flex;
            align-items: center;
        }

        .form-row2 {
            margin-bottom: 12px;

            display: flex;
            align-items: center;
        }

        h2 {
            text-align: center;
            font-size: 25px;
            /* å­—é«”å¤§å° */
            margin: 6px 0;
            /* ä¸Šä¸‹ 16pxï¼Œå·¦å³ 0 */
        }

        label {
            display: inline-block;
            width: 140px;
        }

        input,
        select,
        button {
            padding: 6px;
            width: 220px;
        }

        button {
            width: 350px;
            padding: 10px 16px;
            /* â† é‡é» */
            margin-right: 6px;
            cursor: pointer;
        }

        #result {
            margin-top: 20px;
            padding: 10px;
            border: 1px solid #ccc;
            max-height: 300px;
            overflow-y: auto;
            background: #fafafa;
            font-size: 14px;
        }

        .log {
            margin-bottom: 4px;
        }
    </style>
</head>

<body>

    <h2>è‚¡ç¥¨è³‡æ–™æ›´æ–°</h2>
    <div class="form-container">
        <div class="form-row1">
            <label>å¸¸ç”¨è‚¡ç¥¨ï¼š</label>
            <select id="stockPreset">
                <option value="">-- é¸æ“‡ --</option>
                <option value="0050">0050 å…ƒå¤§å°ç£50</option>
                <option value="0056">0056 é«˜è‚¡æ¯</option>
                <option value="00878">00878 åœ‹æ³°æ°¸çºŒé«˜è‚¡æ¯</option>

                <option value="9924">9924 ç¦èˆˆ</option>
                <option value="8112">8112 è‡³ä¸Š</option>
                <option value="2352">2352 ä½³ä¸–é”</option>
                <option value="1102">1102 äºæ³¥</option>
                <option value="2412">2412 ä¸­è¯é›»</option>
                <option value="2886">2886 å…†è±é‡‘</option>
                <option value="9933">9933 ä¸­é¼</option>
                <option value="2884">2884 ç‰å±±é‡‘</option>
                <option value="2881">2881 å¯Œé‚¦é‡‘</option>
                <option value="2882">2882 åœ‹æ³°é‡‘</option>
                <option value="6188">6188 å»£æ˜</option>
                <option value="2330">2330 å°ç©é›»</option>
            </select>
        </div>

        <div class="form-row1">
            <label>è‚¡ç¥¨ä»£è™Ÿï¼š</label>
            <input type="text" id="stockId" placeholder="ä¾‹å¦‚ 2330" />
        </div>

        <div class="form-row1">
            <label>èµ·å§‹å¹´ä»½ï¼š</label>
            <input type="number" id="startYear" value="2010" />
        </div>

        <div class="form-row2">
            <button onclick="updateSingleStock()">æ›´æ–°å–®ä¸€è‚¡ç¥¨ï¼ˆå–®ä¸€å¹´ï¼‰</button>
            <button onclick="updatePresetStocks()">æ›´æ–°å¸¸ç”¨è‚¡ç¥¨ï¼ˆå–®ä¸€å¹´ï¼‰</button>
            <button onclick="updateAllStocks()">æ›´æ–°å…¨éƒ¨å°è‚¡è‚¡ç¥¨ï¼ˆå–®ä¸€å¹´ï¼‰</button>
            <button onclick="updateAllStockDividend()">æ›´æ–°å…¨éƒ¨è‚¡ç¥¨è‚¡åˆ©è³‡è¨Š</button>
        </div>
    </div>
    <div id="result"></div>

    <script>
        new signalR.HubConnectionBuilder()
            .withUrl("http://localhost:7278/stockUpdateHub")

        const conn = new signalR.HubConnectionBuilder()
            .withUrl("http://localhost:7278/stockUpdateHub", {
                withCredentials: true
            })
            .configureLogging(signalR.LogLevel.Information)
            .build();

        conn.on("Progress", msg => {
            console.log("æ”¶åˆ° Progress:", msg);
            appendLog(msg);
        });

        conn.start()
            .then(() => console.log("âœ… SignalR å·²é€£ç·š"))
            .catch(err => console.error("âŒ SignalR é€£ç·šå¤±æ•—", err));


        const apiBase = "http://localhost:7278";

        const presetStocks = [
            "0050", "0056", "00878", "9924", "8112", "2352", "1102", "2412", "2886", "9933", "2884", "2881", "2882", "6188", "2330"
            //all//"2327", "5880", "3034", "2883", "3008", "2002", "1303", "2603", "6919", "2059","5871", "2207", "5876", "1301", "3045", "4904", "2395", "4938", "2912", "2615","2609", "6505", "6446", "2618", "2376", "2449", "1504", "3036", "2356", "3044","4958", "2324", "2105", "1102", "2347", "6239", "2385", "3005", "3702", "2377","2353", "2474", "2027", "1477", "6176", "9904", "6285", "3023", "1319", "2006","9941", "5347", "1402", "5434", "6257", "4766", "6196", "3030", "4915", "9939","2610", "2206", "1210", "9917", "2393", "6278", "6670", "2504", "2441", "1215","2607", "2850", "3010", "2015", "6605", "3592", "2404", "8299", "6121", "5522","2606", "3211", "2637", "2451", "4763", "2371", "2458", "8112", "6005", "6757","5508", "6412", "8070", "2439", "2520", "1442", "1326", "2409", "2633", "9945","2352", "2845", "2915", "1722", "8454", "5483", "3260", "3264", "6147", "3227","5388", "8016", "4961", "6197", "3617", "3078", "3090", "6206", "2801", "3037","3665", "1101", "2834", "1590", "9910", "1476", "3706", "6472", "6789", "2838","6409", "8210", "2889", "6592", "2211", "2201", "2204", "2855", "8926", "6414","1609", "9933", "2467", "3042", "6214", "2362", "2515", "1707", "9930", "2103","8131", "6806", "5515"
        ];

        document.getElementById("stockPreset").addEventListener("change", function () {
            document.getElementById("stockId").value = this.value;
        });

        function appendLog(message) {
            const container = document.getElementById("result");

            const div = document.createElement("div");
            div.className = "log";
            div.innerText = `[${new Date()}] ${message}`;

            container.appendChild(div);

            // âœ… è‡ªå‹•æ²åˆ°æœ€æ–°è¨Šæ¯
            container.scrollTop = container.scrollHeight;
        }
        async function updateAllStockDividend() {
            appendLog("ğŸš€ é–‹å§‹æ›´æ–°æ‰€æœ‰è‚¡ç¥¨è‚¡åˆ©è³‡è¨Š");

            try {
                const res = await fetch(
                    `${apiBase}/stock/update/dividend/all-stock`,
                    { method: "POST" }
                );

                const text = await res.text();
                appendLog(text);
            }
            catch (err) {
                console.error(err);
                appendLog("âœ– æ›´æ–°æ‰€æœ‰è‚¡ç¥¨è‚¡åˆ©è³‡è¨Šå¤±æ•—");
            }
        }

        async function updateSingleStock() {
            const stockId = document.getElementById("stockId").value;
            const startYear = document.getElementById("startYear").value;

            if (!stockId) {
                alert("è«‹è¼¸å…¥è‚¡ç¥¨ä»£è™Ÿ");
                return;
            }

            appendLog(`é–‹å§‹æ›´æ–°è‚¡ç¥¨ ${stockId}ï¼ˆ${startYear} å¹´ï¼‰`);

            const res = await fetch(`${apiBase}/stock/update/price/single-stock`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    stockId: stockId,
                    startYear: parseInt(startYear)
                })
            });

            const text = await res.text();
            appendLog(text);
        }

        async function updatePresetStocks() {
            const year = document.getElementById("startYear").value;
            const total = presetStocks.length;

            appendLog(`é–‹å§‹æ›´æ–°å¸¸ç”¨è‚¡ç¥¨ï¼ˆ${year} å¹´ï¼‰ï¼Œå…± ${total} æª”`);

            for (let i = 0; i < total; i++) {
                const stockId = presetStocks[i];
                const current = i + 1;

                appendLog(`[${current}/${total}] â†’ æ›´æ–° ${stockId} ä¸­...`);

                try {
                    const res = await fetch(`${apiBase}/stock/update`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            stockId: stockId,
                            startYear: parseInt(year)
                        })
                    });

                    const text = await res.text();
                    appendLog(`[${current}/${total}] âœ” ${stockId} å®Œæˆï¼š${text}`);
                } catch (err) {
                    appendLog(`[${current}/${total}] âœ– ${stockId} å¤±æ•—`);
                }

                // ç¦®è²Œ delayï¼Œé¿å…æ‰“çˆ† API
                await new Promise(r => setTimeout(r, 300));
            }

            appendLog(`å¸¸ç”¨è‚¡ç¥¨æ›´æ–°å®Œæˆï¼ˆ${total}/${total}ï¼‰`);
        }
        function sortStockPreset() {
            const select = document.getElementById("stockPreset");

            // ä¿ç•™ç¬¬ä¸€å€‹ "-- é¸æ“‡ --"
            const defaultOption = select.options[0];

            const options = Array.from(select.options)
                .slice(1)
                .sort((a, b) => a.value.localeCompare(b.value));

            // æ¸…ç©ºå¾Œé‡æ–°åŠ å…¥
            select.innerHTML = "";
            select.appendChild(defaultOption);

            options.forEach(opt => select.appendChild(opt));
        }
        async function updateAllStocks() {
            const year = document.getElementById("startYear").value;

            if (!year) {
                alert("è«‹è¼¸å…¥å¹´ä»½");
                return;
            }

            try {
                const res = await fetch(
                    `${apiBase}/stock/update/price/all-stock?year=${year}`,
                    { method: "POST" }
                );

                const text = await res.text();
                appendLog(text);
            }
            catch {
                appendLog("âœ– æ›´æ–°å°è‚¡è‚¡ç¥¨å¤±æ•—");
            }
        }

        // é é¢è¼‰å…¥å¾Œæ’åº
        sortStockPreset();

    </script>

</body>

</html>