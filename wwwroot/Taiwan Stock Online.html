<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="utf-8" />
    <title>Taiwan Stock Online</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
        }

        .form-row {
            margin-bottom: 12px;
        }

        label {
            display: inline-block;
            width: 140px;
        }

        input,
        select,
        button {
            padding: 6px;
            width: 220px;
        }

        button {
            width: 240px;
            margin-right: 6px;
        }

        #result {
            margin-top: 20px;
            padding: 10px;
            border: 1px solid #ccc;
            max-height: 300px;
            overflow-y: auto;
            background: #fafafa;
            font-size: 14px;
        }

        .log {
            margin-bottom: 4px;
        }
    </style>
</head>

<body>

    <h2>股票日資料更新</h2>

    <div class="form-row">
        <label>常用股票：</label>
        <select id="stockPreset">
            <option value="">-- 選擇 --</option>
            <option value="0050">0050 元大台灣50</option>
            <option value="0056">0056 高股息</option>
            <option value="00878">00878 國泰永續高股息</option>

            <option value="9924">9924 福興</option>
            <option value="8112">8112 至上</option>
            <option value="2352">2352 佳世達</option>
            <option value="1102">1102 亞泥</option>
            <option value="2412">2412 中華電</option>
            <option value="2886">2886 兆豐金</option>
            <option value="9933">9933 中鼎</option>
            <option value="2884">2884 玉山金</option>
            <option value="2881">2881 富邦金</option>
            <option value="2882">2882 國泰金</option>
            <option value="6188">6188 廣明</option>
            <option value="2330">2330 台積電</option>
        </select>
    </div>

    <div class="form-row">
        <label>股票代號：</label>
        <input type="text" id="stockId" placeholder="例如 2330" />
    </div>

    <div class="form-row">
        <label>起始年份：</label>
        <input type="number" id="startYear" value="2010" />
    </div>

    <div class="form-row">
        <button onclick="updateSingleStock()">更新單一股票（起始年 ~ 今年）</button>
        <button onclick="updatePresetStocks()">更新常用股票（單一年）</button>
    </div>

    <div id="result"></div>

    <script>
        const apiBase = "https://localhost:7278";

        const presetStocks = [
            "0050", "0056", "00878",
            "9924", "8112", "2352", "1102", "2412",
            "2886", "9933", "2884", "2881", "2882",
            "6188", "2330"
        ];

        document.getElementById("stockPreset").addEventListener("change", function () {
            document.getElementById("stockId").value = this.value;
        });

        function appendLog(message) {
            const container = document.getElementById("result");

            const div = document.createElement("div");
            div.className = "log";
            div.innerText = `[${new Date()}] ${message}`;

            container.appendChild(div);

            // ✅ 自動捲到最新訊息
            container.scrollTop = container.scrollHeight;
        }

        async function updateSingleStock() {
            const stockId = document.getElementById("stockId").value;
            const startYear = document.getElementById("startYear").value;

            if (!stockId) {
                alert("請輸入股票代號");
                return;
            }

            appendLog(`開始更新股票 ${stockId}（${startYear} ~ 今年）`);

            const res = await fetch(`${apiBase}/stock/update`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    stockId: stockId,
                    startYear: parseInt(startYear)
                })
            });

            const text = await res.text();
            appendLog(text);
        }

        async function updatePresetStocks() {
            const year = document.getElementById("startYear").value;

            appendLog(`開始更新常用股票（${year} 年）`);

            for (const stockId of presetStocks) {
                appendLog(`→ 更新 ${stockId} 中...`);

                try {
                    const res = await fetch(`${apiBase}/stock/update`, {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            stockId: stockId,
                            startYear: parseInt(year)
                        })
                    });

                    const text = await res.text();
                    appendLog(`✔ ${stockId} 完成：${text}`);
                } catch (err) {
                    appendLog(`✖ ${stockId} 失敗`);
                }

                // 禮貌一點，避免連續打 API
                await new Promise(r => setTimeout(r, 300));
            }

            appendLog("常用股票更新完成");
        }
        function sortStockPreset() {
            const select = document.getElementById("stockPreset");

            // 保留第一個 "-- 選擇 --"
            const defaultOption = select.options[0];

            const options = Array.from(select.options)
                .slice(1)
                .sort((a, b) => a.value.localeCompare(b.value));

            // 清空後重新加入
            select.innerHTML = "";
            select.appendChild(defaultOption);

            options.forEach(opt => select.appendChild(opt));
        }

        // 頁面載入後排序
        sortStockPreset();

    </script>

</body>

</html>